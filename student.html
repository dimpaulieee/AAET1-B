<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AAET 1-B | Student Dashboard</title>
<link rel="stylesheet" href="assets/styles.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
<div class="container">

  <!-- Header -->
  <header class="header-card">
    <h1><i class="fas fa-graduation-cap"></i> Welcome to AAET 1-B</h1>
    <p id="sectionMotto" class="motto" style="color: white !important;"></p>
    <div class="welcome-text" style="color: white !important;">
      <p><i class="fas fa-user"></i> Logged in as: <span id="userEmail" style="color: white !important;">Student</span></p>
    </div>
    <button id="logoutBtn" class="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
  </header>

  <div class="dashboard-grid">
    <!-- Left Column -->
    <div class="dashboard-column">
      <!-- Announcements -->
      <section class="section-card highlight">
        <h2><i class="fas fa-bullhorn"></i> Latest Announcements</h2>
        <div id="announcementsList" class="announcements-feed"></div>
      </section>

      <!-- Reviewers -->
      <section class="section-card">
        <h2><i class="fas fa-star"></i> Reviewers</h2>
        <div id="reviewerDisplay" class="reviewer-display">
          <div class="reviewer-content">
            <h3 id="reviewerName">Loading...</h3>
            <p id="reviewerSubject"></p>
            <a id="reviewerLink" href="#" target="_blank" class="resource-link" style="display: none;">
              <i class="fas fa-external-link-alt"></i> Open Resource
            </a>
          </div>
        </div>
        <div class="reviewer-nav">
          <button id="prevReviewerBtn" class="nav-btn"><i class="fas fa-chevron-left"></i> Previous</button>
          <button id="nextReviewerBtn" class="nav-btn">Next <i class="fas fa-chevron-right"></i></button>
        </div>
      </section>
    </div>

    <!-- Right Column -->
    <div class="dashboard-column">
      <!-- Officers -->
      <section class="section-card">
        <h2><i class="fas fa-user-tie"></i> Section Officers</h2>
        <div id="officersList" class="officers-grid"></div>
      </section>

      <!-- Pictures Carousel -->
      <section class="section-card">
        <h2><i class="fas fa-images"></i> Section Gallery</h2>
        <div id="picturesCarousel" class="gallery-carousel"></div>
        <div class="carousel-controls">
          <button id="prevBtn" class="carousel-btn"><i class="fas fa-chevron-left"></i></button>
          <button id="nextBtn" class="carousel-btn"><i class="fas fa-chevron-right"></i></button>
        </div>
      </section>
    </div>
  </div>

</div>

<script type="module">
import { db, auth } from './js/firebase.js';
import { collection, getDocs, doc, getDoc, orderBy, query, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import { signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

// Logout
document.getElementById('logoutBtn').addEventListener('click', async () => {
  await signOut(auth);
  window.location.href = 'index.html';
});

// Check auth state
onAuthStateChanged(auth, (user) => {
  if (user) {
    document.getElementById('userEmail').textContent = user.email;
  } else {
    window.location.href = 'index.html';
  }
});

/* ===== Section Motto ===== */
async function loadMotto() {
  try {
    const docRef = doc(db, 'sectionInfo', 'AAET1B');
    const snap = await getDoc(docRef);
    const motto = snap.exists() ? `"${snap.data().motto || 'Excellence, Unity, and Growth'}"` : '"Excellence, Unity, and Growth"';
    document.getElementById('sectionMotto').innerText = motto;
  } catch (error) {
    console.error('Error loading motto:', error);
    document.getElementById('sectionMotto').innerText = '"Excellence, Unity, and Growth"';
  }
}

/* ===== Pictures Carousel ===== */
let currentImageIndex = 0;
let images = [];

async function loadPictures() {
  try {
    const carousel = document.getElementById('picturesCarousel');
    images = [];
    
    const q = query(collection(db, 'pictures'), orderBy('createdAt', 'desc'));
    const snapshot = await getDocs(q);
    
    snapshot.forEach(docSnap => {
      const picture = docSnap.data();
      if (picture.url) {
        images.push({
          url: picture.url,
          description: picture.description || 'Section picture'
        });
      }
    });
    
    updateCarousel();
    
    if (images.length > 0) {
      startCarousel();
    }
    
    // Set up real-time updates
    onSnapshot(q, (snapshot) => {
      images = [];
      snapshot.forEach(docSnap => {
        const picture = docSnap.data();
        if (picture.url) {
          images.push({
            url: picture.url,
            description: picture.description || 'Section picture'
          });
        }
      });
      updateCarousel();
    });
    
  } catch (error) {
    console.error('Error loading pictures:', error);
    document.getElementById('picturesCarousel').innerHTML = 
      '<p class="no-content" style="color: #333; padding: 20px; text-align: center;">Unable to load pictures</p>';
  }
}

function updateCarousel() {
  const carousel = document.getElementById('picturesCarousel');
  carousel.innerHTML = '';
  
  if (images.length === 0) {
    carousel.innerHTML = '<p class="no-content" style="color: #333; padding: 20px; text-align: center;">No pictures available yet.</p>';
    return;
  }
  
  const currentImage = images[currentImageIndex];
  
  const imgContainer = document.createElement('div');
  imgContainer.style.position = 'relative';
  imgContainer.style.width = '100%';
  imgContainer.style.height = '100%';
  
  const img = document.createElement('img');
  img.src = currentImage.url;
  img.alt = currentImage.description;
  img.classList.add('carousel-img');
  img.style.width = '100%';
  img.style.height = '100%';
  img.style.objectFit = 'cover';
  img.style.borderRadius = '10px';
  img.style.opacity = '1';
  
  // Add error handling for images
  img.onerror = function() {
    this.src = 'https://via.placeholder.com/300x200?text=Image+Not+Found';
  };
  
  const caption = document.createElement('div');
  caption.className = 'carousel-caption';
  caption.textContent = currentImage.description;
  caption.style.position = 'absolute';
  caption.style.bottom = '0';
  caption.style.left = '0';
  caption.style.right = '0';
  caption.style.background = 'rgba(0, 0, 0, 0.7)';
  caption.style.color = 'white';
  caption.style.padding = '10px';
  caption.style.textAlign = 'center';
  caption.style.fontSize = '0.9rem';
  
  imgContainer.appendChild(img);
  imgContainer.appendChild(caption);
  carousel.appendChild(imgContainer);
}

document.getElementById('nextBtn').addEventListener('click', () => {
  if (images.length === 0) return;
  currentImageIndex = (currentImageIndex + 1) % images.length;
  updateCarousel();
});

document.getElementById('prevBtn').addEventListener('click', () => {
  if (images.length === 0) return;
  currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
  updateCarousel();
});

// Auto-rotate carousel
let carouselInterval;
function startCarousel() {
  if (images.length <= 1) return;
  
  clearInterval(carouselInterval);
  carouselInterval = setInterval(() => {
    currentImageIndex = (currentImageIndex + 1) % images.length;
    updateCarousel();
  }, 5000);
}

function stopCarousel() {
  clearInterval(carouselInterval);
}

document.getElementById('picturesCarousel').addEventListener('mouseenter', stopCarousel);
document.getElementById('picturesCarousel').addEventListener('mouseleave', startCarousel);

/* ===== Officers ===== */
async function loadOfficers() {
  try {
    const officersList = document.getElementById('officersList');
    
    const q = query(collection(db, 'officers'), orderBy('position'));
    const snapshot = await getDocs(q);
    
    if (snapshot.empty) {
      officersList.innerHTML = '<p class="no-content" style="color: #333; text-align: center; padding: 20px;">No officers assigned yet.</p>';
      return;
    }
    
    officersList.innerHTML = '';
    snapshot.forEach((docSnap, index) => {
      const officer = docSnap.data();
      const officerCard = document.createElement('div');
      officerCard.className = 'officer-card';
      officerCard.innerHTML = `
        <div class="officer-icon">
          <i class="fas fa-user-tie"></i>
        </div>
        <div class="officer-details">
          <h4>${officer.position || ''}</h4>
          <p>${officer.name || ''}</p>
        </div>
      `;
      officerCard.style.animation = 'fadeInUp 0.5s ease';
      officerCard.style.animationDelay = `${index * 0.1}s`;
      officersList.appendChild(officerCard);
    });
    
    // Set up real-time updates
    onSnapshot(q, (snapshot) => {
      loadOfficers();
    });
    
  } catch (error) {
    console.error('Error loading officers:', error);
    document.getElementById('officersList').innerHTML = 
      '<p class="no-content" style="color: #333; text-align: center; padding: 20px;">Error loading officers</p>';
  }
}

/* ===== Announcements ===== */
async function loadAnnouncements() {
  try {
    const announcementsList = document.getElementById('announcementsList');
    
    const q = query(collection(db, 'announcements'), orderBy('createdAt', 'desc'));
    const snapshot = await getDocs(q);
    
    if (snapshot.empty) {
      announcementsList.innerHTML = '<p class="no-content" style="color: #333; text-align: center; padding: 20px;">No announcements yet.</p>';
      return;
    }
    
    announcementsList.innerHTML = '';
    snapshot.forEach((docSnap, index) => {
      const announcement = docSnap.data();
      const date = new Date(announcement.createdAt).toLocaleDateString('en-US', {
        weekday: 'short',
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
      
      const announcementCard = document.createElement('div');
      announcementCard.className = 'announcement-card';
      announcementCard.innerHTML = `
        <div class="announcement-header">
          <h4>${announcement.title || ''}</h4>
          <span class="announcement-time">${date}</span>
        </div>
        <p>${announcement.content || ''}</p>
        <div class="announcement-footer">
          <small><i class="fas fa-user"></i> ${announcement.createdBy || 'Admin'}</small>
        </div>
      `;
      announcementCard.style.animation = 'slideInRight 0.5s ease';
      announcementCard.style.animationDelay = `${index * 0.1}s`;
      announcementsList.appendChild(announcementCard);
    });
    
    // Set up real-time updates
    onSnapshot(q, (snapshot) => {
      loadAnnouncements();
    });
    
  } catch (error) {
    console.error('Error loading announcements:', error);
    document.getElementById('announcementsList').innerHTML = 
      '<p class="no-content" style="color: #333; text-align: center; padding: 20px;">Error loading announcements</p>';
  }
}

/* ===== Reviewers ===== */
let reviewers = [];
let reviewerIndex = 0;

async function loadReviewers() {
  try {
    const q = query(collection(db, 'reviewers'), orderBy('createdAt', 'desc'));
    const snapshot = await getDocs(q);
    
    reviewers = [];
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      reviewers.push({ 
        id: docSnap.id, 
        name: data.name || '',
        subject: data.subject || '',
        link: data.link || '',
        featured: data.featured || false
      });
    });
    
    if (reviewers.length > 0) {
      showReviewer();
      startReviewerCycle();
    } else {
      document.getElementById('reviewerName').textContent = 'No reviewers available';
      document.getElementById('reviewerSubject').textContent = 'Check back later for reviewer materials';
      document.getElementById('reviewerLink').style.display = 'none';
    }
    
    // Set up real-time updates
    onSnapshot(q, (snapshot) => {
      reviewers = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        reviewers.push({ 
          id: docSnap.id, 
          name: data.name || '',
          subject: data.subject || '',
          link: data.link || '',
          featured: data.featured || false
        });
      });
      
      if (reviewers.length > 0) {
        if (reviewerIndex >= reviewers.length) {
          reviewerIndex = 0;
        }
        showReviewer();
      }
    });
    
  } catch (error) {
    console.error('Error loading reviewers:', error);
    document.getElementById('reviewerName').textContent = 'Error loading reviewers';
    document.getElementById('reviewerSubject').textContent = '';
    document.getElementById('reviewerLink').style.display = 'none';
  }
}

function showReviewer() {
  if (reviewers.length === 0) return;
  
  const reviewer = reviewers[reviewerIndex];
  const reviewerName = document.getElementById('reviewerName');
  const reviewerSubject = document.getElementById('reviewerSubject');
  const reviewerLink = document.getElementById('reviewerLink');
  
  reviewerName.innerHTML = reviewer.name;
  reviewerSubject.textContent = reviewer.subject;
  
  if (reviewer.link && reviewer.link.trim() !== '') {
    // Ensure the link has proper protocol
    let link = reviewer.link.trim();
    if (!link.startsWith('http://') && !link.startsWith('https://')) {
      link = 'https://' + link;
    }
    
    reviewerLink.href = link;
    reviewerLink.style.display = 'inline-block';
    reviewerLink.textContent = 'Open Resource';
    reviewerLink.target = '_blank';
  } else {
    reviewerLink.style.display = 'none';
  }
  
  if (reviewer.featured) {
    reviewerName.innerHTML = `${reviewer.name} <span class="featured-badge">ðŸŒŸ Featured</span>`;
  }
}

document.getElementById('nextReviewerBtn').addEventListener('click', () => {
  if (reviewers.length === 0) return;
  reviewerIndex = (reviewerIndex + 1) % reviewers.length;
  showReviewer();
});

document.getElementById('prevReviewerBtn').addEventListener('click', () => {
  if (reviewers.length === 0) return;
  reviewerIndex = (reviewerIndex - 1 + reviewers.length) % reviewers.length;
  showReviewer();
});

// Auto-cycle reviewers every 10 seconds
let reviewerInterval;
function startReviewerCycle() {
  if (reviewers.length <= 1) return;
  
  clearInterval(reviewerInterval);
  reviewerInterval = setInterval(() => {
    reviewerIndex = (reviewerIndex + 1) % reviewers.length;
    showReviewer();
  }, 10000);
}

/* ===== Initialize Everything ===== */
async function init() {
  try {
    await Promise.all([
      loadMotto(),
      loadPictures(),
      loadOfficers(),
      loadAnnouncements(),
      loadReviewers()
    ]);
    
    console.log('Student dashboard loaded successfully');
  } catch (error) {
    console.error('Error initializing dashboard:', error);
  }
}

// Initialize when page loads
window.addEventListener('DOMContentLoaded', init);

// Add touch support for mobile
let touchStartX = 0;
let touchEndX = 0;

document.getElementById('picturesCarousel').addEventListener('touchstart', (e) => {
  touchStartX = e.changedTouches[0].screenX;
});

document.getElementById('picturesCarousel').addEventListener('touchend', (e) => {
  touchEndX = e.changedTouches[0].screenX;
  handleSwipe();
});

function handleSwipe() {
  const swipeThreshold = 50;
  const diff = touchStartX - touchEndX;
  
  if (Math.abs(diff) > swipeThreshold) {
    if (diff > 0) {
      // Swipe left - next image
      if (images.length > 0) {
        currentImageIndex = (currentImageIndex + 1) % images.length;
        updateCarousel();
      }
    } else {
      // Swipe right - previous image
      if (images.length > 0) {
        currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
        updateCarousel();
      }
    }
  }
}
</script>

<style>
/* Additional styles for student dashboard */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
  gap: 30px;
  margin-top: 20px;
}

.dashboard-column {
  display: flex;
  flex-direction: column;
  gap: 25px;
}

.welcome-text {
  margin-top: 10px;
  font-size: 0.9rem;
  opacity: 0.8;
}

.highlight {
  border: 2px solid #667eea;
  background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
}

.announcements-feed {
  display: flex;
  flex-direction: column;
  gap: 15px;
  max-height: 400px;
  overflow-y: auto;
  padding-right: 10px;
}

.announcements-feed::-webkit-scrollbar {
  width: 5px;
}

.announcements-feed::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
}

.announcements-feed::-webkit-scrollbar-thumb {
  background: #667eea;
  border-radius: 10px;
}

.announcement-card {
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
  border-left: 4px solid #667eea;
  transition: all 0.3s ease;
  color: #333 !important;
  opacity: 1 !important;
  animation: fadeIn 0.5s ease !important;
}

.announcement-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.announcement-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 10px;
}

.announcement-header h4 {
  margin: 0;
  color: #333;
  font-size: 1.1rem;
}

.announcement-time {
  font-size: 0.8rem;
  color: #666;
  background: #f0f0f0;
  padding: 3px 8px;
  border-radius: 10px;
  white-space: nowrap;
}

.announcement-card p {
  color: #555;
  line-height: 1.5;
  margin: 10px 0;
}

.announcement-footer {
  margin-top: 15px;
  padding-top: 10px;
  border-top: 1px solid #eee;
  color: #777;
  font-size: 0.8rem;
}

.officers-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 15px;
}

.officer-card {
  background: white;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
  transition: all 0.3s ease;
  color: #333 !important;
  opacity: 1 !important;
  animation: fadeIn 0.5s ease !important;
}

.officer-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
}

.officer-icon {
  font-size: 2.5rem;
  color: #667eea;
  margin-bottom: 10px;
}

.officer-details h4 {
  margin: 0;
  color: #333;
  font-size: 1rem;
}

.officer-details p {
  margin: 5px 0 0;
  color: #666;
  font-size: 0.9rem;
}

.gallery-carousel {
  position: relative;
  height: 300px;
  border-radius: 15px;
  overflow: hidden;
  background: #f8f9fa;
  display: flex;
  justify-content: center;
  align-items: center;
}

.carousel-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  opacity: 1 !important;
}

.carousel-caption {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 10px;
  text-align: center;
  font-size: 0.9rem;
}

.carousel-controls {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-top: 15px;
}

.carousel-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #667eea;
  color: white;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
}

.carousel-btn:hover {
  background: #5568d4;
  transform: scale(1.1);
}

.reviewer-display {
  background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%);
  padding: 30px;
  border-radius: 15px;
  text-align: center;
  margin-bottom: 20px;
  border: 2px solid #667eea20;
  transition: all 0.5s ease;
  color: #333 !important;
  opacity: 1 !important;
}

.reviewer-display:hover {
  border-color: #667eea40;
  transform: translateY(-5px);
}

.reviewer-content h3 {
  font-size: 1.5rem;
  margin-bottom: 10px;
  color: #333;
}

.reviewer-content p {
  font-size: 1.1rem;
  color: #666;
  margin-bottom: 15px;
}

.resource-link {
  display: inline-block;
  padding: 10px 20px;
  background: #667eea;
  color: white;
  text-decoration: none;
  border-radius: 25px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.resource-link:hover {
  background: #5568d4;
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
}

.reviewer-nav {
  display: flex;
  justify-content: center;
  gap: 15px;
}

.nav-btn {
  padding: 12px 25px;
  background: #f0f0f0;
  color: #333;
  border: none;
  border-radius: 25px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 500;
}

.nav-btn:hover {
  background: #667eea;
  color: white;
  transform: translateY(-2px);
}

.no-content {
  text-align: center;
  color: #999;
  padding: 40px;
  font-style: italic;
}

.featured-badge {
  display: inline-block;
  background: #ffd700;
  color: #333;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.7rem;
  margin-left: 8px;
  font-weight: bold;
}

@keyframes float {
  0%, 100% {
    transform: translateY(0) rotate(0deg);
  }
  50% {
    transform: translateY(-20px) rotate(5deg);
  }
}

/* ================= Mobile Responsive ================= */
@media (max-width: 768px) {
  .dashboard-grid {
    grid-template-columns: 1fr !important;
    gap: 20px !important;
  }
  
  .dashboard-column {
    gap: 20px;
  }
  
  .header-card h1 {
    font-size: 1.5rem !important;
    margin-right: 80px;
  }
  
  .logoutBtn {
    position: absolute !important;
    top: 20px;
    right: 20px;
    padding: 8px 15px !important;
    font-size: 0.9rem !important;
  }
  
  .officers-grid {
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 10px;
  }
  
  .gallery-carousel {
    height: 200px !important;
  }
  
  .reviewer-display {
    padding: 20px 15px !important;
  }
  
  .reviewer-nav {
    flex-direction: column !important;
    gap: 10px;
  }
  
  .nav-btn {
    width: 100% !important;
  }
  
  .announcements-feed {
    max-height: 300px;
  }
  
  .announcement-card {
    padding: 15px !important;
  }
}

@media (max-width: 480px) {
  .container {
    padding: 10px !important;
  }
  
  .officers-grid {
    grid-template-columns: 1fr !important;
  }
  
  .header-card {
    padding: 20px 15px !important;
    text-align: center;
  }
  
  .header-card h1 {
    margin-right: 0 !important;
    font-size: 1.3rem !important;
  }
  
  .logoutBtn {
    position: relative !important;
    top: 0 !important;
    right: 0 !important;
    margin: 10px auto !important;
    width: 100%;
  }
  
  .section-card {
    padding: 20px 15px !important;
  }
  
  .reviewer-content h3 {
    font-size: 1.2rem;
  }
  
  .reviewer-content p {
    font-size: 1rem;
  }
}
</style>
</body>
</html>
